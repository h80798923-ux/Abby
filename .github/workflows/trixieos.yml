name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ROOTFS: work/rootfs
      ISO: work/iso

    steps:
    - uses: actions/checkout@v4

    - name: Host deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libncurses-dev libssl-dev \
          grub-pc-bin grub-common xorriso \
          wget curl tar gzip xz-utils cpio rsync python3

    - name: Prepare dirs
      run: |
        mkdir -p $ROOTFS $ISO

    - name: Alpine bootstrap (hidden)
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C $ROOTFS

    - name: Base system (FIXED)
      run: |
        sudo mount --bind /dev $ROOTFS/dev
        sudo mount --bind /proc $ROOTFS/proc
        sudo mount --bind /sys $ROOTFS/sys

        sudo chroot $ROOTFS /bin/sh <<'EOF'
        set -e
        echo "nameserver 8.8.8.8" > /etc/resolv.conf

        apk update

        apk add --no-cache \
          openrc \
          xfce4 xfce4-terminal \
          xorg-server xinit \
          lightdm lightdm-gtk-greeter \
          networkmanager dbus udev elogind \
          sudo curl jq \
          python3 py3-gobject3 gtk+3.0 \
          linux-firmware

        rc-update add dbus default
        rc-update add lightdm default

        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        adduser trixieuser wheel
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers

        echo "exec startxfce4" > /home/trixieuser/.xinitrc
        chown trixieuser:trixieuser /home/trixieuser/.xinitrc

        cat > /etc/os-release <<EOL
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        EOL
        EOF

    - name: TRX GUI App
      run: |
        sudo chroot $ROOTFS /bin/sh <<'EOF'
        mkdir -p /usr/bin /usr/share/applications /opt/trx/apps

        cat > /usr/bin/trx-gui <<'PYEOF'
        #!/usr/bin/env python3
        import gi, subprocess
        gi.require_version("Gtk", "3.0")
        from gi.repository import Gtk

        class TRX(Gtk.Window):
            def __init__(self):
                super().__init__(title="TRX Uygulama Merkezi")
                self.set_default_size(500, 200)

                box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
                box.set_border_width(10)
                self.add(box)

                self.entry = Gtk.Entry()
                self.entry.set_placeholder_text("GitHub repo (user/proje)")
                box.pack_start(self.entry, False, False, 0)

                btn = Gtk.Button(label="İndir")
                btn.connect("clicked", self.install)
                box.pack_start(btn, False, False, 0)

                self.status = Gtk.Label()
                box.pack_start(self.status, False, False, 0)

            def install(self, w):
                repo = self.entry.get_text().strip()
                if not repo:
                    return
                self.status.set_text("İndiriliyor...")
                subprocess.Popen([
                    "sh","-c",
                    f"curl -s https://api.github.com/repos/{repo}/releases/latest | "
                    "jq -r '.assets[].browser_download_url' | "
                    "grep -E '\\.(tar.xz|tar.gz|txz)$' | "
                    "head -n1 | xargs -n1 wget -P /opt/trx/apps"
                ])
                self.status.set_text("Bitti")

        win = TRX()
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()
        PYEOF

        chmod +x /usr/bin/trx-gui

        cat > /usr/share/applications/trx.desktop <<EOF2
        [Desktop Entry]
        Name=TRX Uygulama Merkezi
        Exec=trx-gui
        Type=Application
        Categories=System;
        EOF2
        EOF

    - name: Kernel build
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        make modules_install INSTALL_MOD_PATH=../$ROOTFS
        cp arch/x86/boot/bzImage ../$ISO/vmlinuz

    - name: Initramfs
      run: |
        cd $ROOTFS
        find . | cpio -H newc -o | gzip > ../iso/initrd.img

    - name: GRUB
      run: |
        mkdir -p $ISO/boot/grub
        cat > $ISO/boot/grub/grub.cfg <<'EOF'
        set timeout=2
        menuentry "TrixieOs ProjectA tarafından yapıldı" {
          linux /vmlinuz root=/dev/ram0 rw quiet
          initrd /initrd.img
        }
        EOF

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOs.iso $ISO

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOs
        path: TrixieOs.iso
