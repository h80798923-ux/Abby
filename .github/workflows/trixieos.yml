name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ROOTFS: work/rootfs
      KERNEL_VER: 6.6.8

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install host dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev \
          libelf-dev elfutils \
          grub-pc-bin grub-common \
          xorriso wget curl \
          tar gzip xz-utils cpio rsync \
          python3 jq

    # -----------------------------
    # Alpine bootstrap
    # -----------------------------
    - name: Download Alpine minirootfs
      run: |
        mkdir -p work
        wget -O alpine.tar.gz https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        mkdir -p $ROOTFS
        sudo tar -xzf alpine.tar.gz -C $ROOTFS

    - name: Prepare chroot
      run: |
        sudo mount --bind /dev $ROOTFS/dev
        sudo mount --bind /proc $ROOTFS/proc
        sudo mount --bind /sys $ROOTFS/sys
        echo "nameserver 1.1.1.1" | sudo tee $ROOTFS/etc/resolv.conf

    # -----------------------------
    # Base system + GUI
    # -----------------------------
    - name: Install base packages
      run: |
        sudo chroot $ROOTFS /bin/sh <<'EOF'
        set -e
        apk update

        apk add \
          alpine-base \
          openrc \
          elogind \
          dbus \
          udev \
          sudo \
          networkmanager \
          xfce4 \
          xfce4-terminal \
          lightdm \
          lightdm-gtk-greeter \
          xorg-server \
          xinit \
          mesa-dri-gallium

        rc-update add dbus default
        rc-update add elogind default
        rc-update add udev default
        rc-update add lightdm default
        EOF

    # -----------------------------
    # User
    # -----------------------------
    - name: Create trixieuser
      run: |
        sudo chroot $ROOTFS /bin/sh <<'EOF'
        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        addgroup trixieuser wheel
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers
        EOF

    # -----------------------------
    # Kernel build
    # -----------------------------
    - name: Build Linux kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VER}.tar.xz
        tar -xf linux-${KERNEL_VER}.tar.xz
        cd linux-${KERNEL_VER}

        make x86_64_defconfig
        make -j$(nproc)
        make INSTALL_MOD_PATH=../modules modules_install

        cp arch/x86/boot/bzImage ../vmlinuz
        cd ..

        sudo mkdir -p $ROOTFS/boot
        sudo cp vmlinuz $ROOTFS/boot/vmlinuz
        sudo cp -r modules/lib/modules $ROOTFS/lib/

    # -----------------------------
    # Init
    # -----------------------------
    - name: Init system
      run: |
        sudo chroot $ROOTFS /bin/sh <<'EOF'
        echo "tty1::respawn:/sbin/getty 38400 tty1" > /etc/inittab
        EOF

    # -----------------------------
    # ISO
    # -----------------------------
    - name: Create ISO
      run: |
        mkdir -p iso/boot/grub
        cp $ROOTFS/boot/vmlinuz iso/boot/
        
        cat > iso/boot/grub/grub.cfg <<EOF
        set timeout=0
        menuentry "TrixieOs" {
          linux /boot/vmlinuz root=/dev/ram0 rw quiet
        }
        EOF

        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs
        path: TrixieOs.iso
