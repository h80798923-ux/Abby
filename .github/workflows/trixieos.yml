name: TrixieOS ISO Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev \
          grub-pc-bin grub-common \
          mtools xorriso \
          wget curl rsync \
          squashfs-tools \
          qemu-utils

    - name: Prepare directories
      run: |
        mkdir -p work/rootfs iso/boot/grub

    - name: Alpine bootstrap
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C work/rootfs

    - name: Mount system dirs
      run: |
        sudo mount --bind /dev work/rootfs/dev
        sudo mount -t proc proc work/rootfs/proc
        sudo mount -t sysfs sysfs work/rootfs/sys

    - name: Configure Alpine base + XFCE
      run: |
        sudo chroot work/rootfs /bin/sh <<'EOF'
        set -e

        echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/main" > /etc/apk/repositories
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/community" >> /etc/apk/repositories

        apk update

        apk add --no-cache \
          alpine-base \
          openrc \
          dbus \
          bash \
          sudo \
          elogind \
          xorg-server \
          xinit \
          xfce4 \
          xfce4-terminal \
          xfce4-session \
          xfce4-panel \
          xfce4-settings \
          xfwm4 \
          thunar \
          lightdm \
          lightdm-gtk-greeter \
          gtk+3.0-base \
          python3 \
          py3-gobject \
          py3-requests

        rc-update add dbus default
        rc-update add elogind default
        rc-update add lightdm default

        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        addgroup trixieuser wheel
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers

        echo "exec startxfce4" > /home/trixieuser/.xinitrc
        chown trixieuser:trixieuser /home/trixieuser/.xinitrc

        ln -s /etc/init.d/lightdm /etc/init.d/display-manager

        EOF

    - name: Build Linux kernel 6.6
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        make modules_install INSTALL_MOD_PATH=../work/rootfs
        cp arch/x86/boot/bzImage ../iso/boot/vmlinuz

    - name: Create initramfs
      run: |
        sudo chroot work/rootfs /bin/sh <<'EOF'
        apk add --no-cache mkinitfs
        mkinitfs -o /boot/initramfs
        EOF
        sudo cp work/rootfs/boot/initramfs iso/boot/initramfs

    - name: GRUB config
      run: |
        cat > iso/boot/grub/grub.cfg <<'EOF'
        set timeout=0
        set default=0

        menuentry "TrixieOS" {
          linux /boot/vmlinuz quiet
          initrd /boot/initramfs
        }
        EOF

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOS.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: TrixieOS.iso
