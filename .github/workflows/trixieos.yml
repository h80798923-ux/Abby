name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ARCH: x86_64
      ROOTFS: work/rootfs
      ISO: work/iso

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install host deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libncurses-dev libssl-dev \
          grub-pc-bin grub-common xorriso squashfs-tools \
          wget curl tar gzip xz-utils cpio rsync

    - name: Prepare dirs
      run: |
        mkdir -p work
        mkdir -p $ROOTFS
        mkdir -p $ISO

    - name: Alpine bootstrap (hidden)
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C $ROOTFS

    - name: Base system setup
      run: |
        sudo mount --bind /dev $ROOTFS/dev
        sudo mount --bind /proc $ROOTFS/proc
        sudo mount --bind /sys $ROOTFS/sys

        sudo chroot $ROOTFS /bin/sh <<'EOF'
        set -e

        echo "nameserver 8.8.8.8" > /etc/resolv.conf

        apk update

        apk add --no-cache \
          openrc openrc-base \
          xfce4 xfce4-terminal \
          xorg-server xinit \
          lightdm lightdm-gtk-greeter \
          networkmanager dbus udev elogind \
          sudo curl jq \
          python3 py3-gobject3 gtk+3.0 \
          linux-firmware

        rc-update add dbus default
        rc-update add NetworkManager default
        rc-update add lightdm default

        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        adduser trixieuser wheel
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers

        echo "exec startxfce4" > /home/trixieuser/.xinitrc
        chown trixieuser:trixieuser /home/trixieuser/.xinitrc

        cat > /etc/os-release <<EOL
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        EOL

        rm -rf /var/cache/apk/*
        EOF

    - name: Build Linux kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        make modules_install INSTALL_MOD_PATH=../$ROOTFS
        cp arch/x86/boot/bzImage ../$ISO/vmlinuz

    - name: Initramfs
      run: |
        cd $ROOTFS
        find . | cpio -H newc -o | gzip > ../$ISO/initrd.img

    - name: GRUB config
      run: |
        mkdir -p $ISO/boot/grub
        cat > $ISO/boot/grub/grub.cfg <<'EOF'
        set timeout=3
        menuentry "TrixieOs ProjectA tarafından yapıldı" {
          linux /vmlinuz root=/dev/ram0 rw quiet
          initrd /initrd.img
        }
        EOF

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOs.iso $ISO

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
